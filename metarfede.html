<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>METAR / TAF â€¢ Simple Dashboard</title>

<style>
  :root{
    --bg:#06102a;
    --panel:#0a2f63;
    --panel2:#0a2a58;
    --card:#073d7a;
    --stroke: rgba(255,255,255,.10);
    --txt:#ffffff;
    --muted: rgba(255,255,255,.75);
    --good:#20a354;
    --accent:#2fb4ff;
    --shadow: 0 18px 50px rgba(0,0,0,.35);
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: linear-gradient(180deg, var(--panel), var(--panel2));
    color: var(--txt);
  }

  .wrap{max-width:1200px; margin:16px auto; padding:14px;}

  .topbar{
    display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;
    padding:10px 4px 16px 4px;
  }
  .title{font-size:20px; font-weight:900;}
  .sub{color:var(--muted); font-size:12px; margin-top:4px;}

  .searchRow{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    background: rgba(0,0,0,.12);
    border:1px solid var(--stroke);
    border-radius:16px;
    padding:12px;
    box-shadow: var(--shadow);
  }
  .searchWrap{flex:1; min-width:260px; position:relative;}
  input{
    width:100%;
    padding:14px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.16);
    background: rgba(0,0,0,.18);
    color:var(--txt);
    font-size:15px;
    outline:none;
  }
  input:focus{border-color: rgba(47,180,255,.55)}
  button{
    padding:14px 16px;
    border:0;
    border-radius:14px;
    background: var(--accent);
    color:#00122a;
    font-weight:900;
    cursor:pointer;
  }
  button:disabled{opacity:.6; cursor:not-allowed}

  .sug{
    position:absolute; left:0; right:0; top:56px;
    background: rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.14);
    border-radius:14px;
    max-height:320px;
    overflow:auto;
    display:none;
    z-index:99;
    backdrop-filter: blur(10px);
  }
  .sugItem{padding:10px 12px; cursor:pointer; border-bottom:1px solid rgba(255,255,255,.10)}
  .sugItem:hover{background: rgba(255,255,255,.08)}
  .sugItem b{color: var(--accent)}
  .sugItem small{display:block; color:var(--muted); margin-top:3px}

  .metarHeader{
    margin-top:14px;
    background: rgba(0,0,0,.15);
    border:1px solid var(--stroke);
    border-radius:16px;
    padding:14px;
    box-shadow: var(--shadow);
  }
  .metarHeader .h1{font-size:18px; font-weight:900}
  .metarHeader .h2{color:var(--muted); font-size:12px; margin-top:6px}

  .grid6{
    margin-top:14px;
    display:grid;
    grid-template-columns: repeat(6, 1fr);
    gap:12px;
  }
  @media (max-width: 1100px){ .grid6{grid-template-columns: repeat(3, 1fr);} }
  @media (max-width: 650px){ .grid6{grid-template-columns: repeat(2, 1fr);} }

  .bigCard{
    border-radius:14px;
    padding:16px;
    background: rgba(0,0,0,.14);
    border:1px solid var(--stroke);
    box-shadow: var(--shadow);
    min-height:92px;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .bigCard.green{background: rgba(32,163,84,.18); border-color: rgba(32,163,84,.35);}
  .bigTop{font-size:12px; color:var(--muted); font-weight:800}
  .bigVal{font-size:24px; font-weight:1000; letter-spacing:.2px}
  .bigSub{font-size:12px; color:var(--muted); margin-top:6px}

  .windRow{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
  }
  .windMini{
    width:44px; height:44px; border-radius:50%;
    border:2px solid rgba(255,255,255,.20);
    display:flex; align-items:center; justify-content:center;
    background: rgba(0,0,0,.10);
    position:relative;
  }
  .windNeedle{
    width:2px; height:18px; background: var(--accent);
    transform-origin: 50% 85%;
    border-radius:2px;
    position:absolute;
    top:10px;
  }
  .windDot{
    width:6px; height:6px; background: var(--accent);
    border-radius:50%;
    position:absolute; bottom:10px;
  }

  .runwaysCard{
    margin-top:16px;
    background: rgba(0,0,0,.15);
    border:1px solid var(--stroke);
    border-radius:16px;
    padding:14px;
    box-shadow: var(--shadow);
  }
  .twoCols{display:grid; grid-template-columns:1fr 1fr; gap:14px;}
  @media (max-width: 820px){ .twoCols{grid-template-columns:1fr;} }

  .secTitle{display:flex; justify-content:space-between; align-items:center; gap:10px}
  .secTitle h3{margin:0; font-size:14px; font-weight:900}
  .hint{color:var(--muted); font-size:12px}

  .rwyGrid{
    margin-top:10px;
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap:10px;
  }
  .rwyTile{
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.12);
    border-radius:14px;
    padding:12px;
    text-align:center;
  }
  .rwyTile.best{
    border-color: rgba(47,180,255,.65);
    background: rgba(47,180,255,.16);
  }
  .rwyTile .r{font-weight:1000; font-size:16px}
  .rwyTile .s{color:var(--muted); font-size:12px; margin-top:6px}

  .tabs{display:flex; gap:10px; margin-top:14px}
  .tab{
    flex:1; text-align:center;
    padding:12px;
    border-radius:14px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.12);
    cursor:pointer;
    font-weight:900;
    color: rgba(255,255,255,.9);
  }
  .tab.active{
    background: rgba(47,180,255,.18);
    border-color: rgba(47,180,255,.55);
  }
  .raw{
    margin-top:10px;
    border-radius:16px;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.12);
    padding:14px;
    white-space:pre-wrap;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono";
    font-size:12.5px;
    line-height:1.35;
    min-height:110px;
  }

  .foot{margin-top:10px; color:var(--muted); font-size:12px}
</style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <div class="title">METAR & TAF</div>
      <div class="sub">Scrivi cittÃ /aeroporto/IATA/ICAO (es. Bari, Foggia, BRI, LIBD)</div>
    </div>
    <div class="sub" id="dbState">Database: caricamentoâ€¦</div>
  </div>

  <div class="searchRow">
    <div class="searchWrap">
      <input id="search" placeholder="Aeroporto, cittÃ , codiceâ€¦" autocomplete="off">
      <div class="sug" id="sug"></div>
    </div>
    <button id="btn" disabled>Carica</button>
  </div>

  <div class="metarHeader">
    <div class="h1" id="hdrName">â€”</div>
    <div class="h2" id="hdrSub">â€”</div>

    <div class="grid6">
      <div class="bigCard green">
        <div class="bigTop">CONDIZIONI</div>
        <div class="bigVal" id="rules">â€”</div>
        <div class="bigSub" id="warn">â€”</div>
      </div>

      <div class="bigCard">
        <div class="bigTop">TEMPERATURA</div>
        <div class="bigVal" id="temp">â€”</div>
        <div class="bigSub" id="dew">â€”</div>
      </div>

      <div class="bigCard">
        <div class="bigTop">VENTO</div>
        <div class="windRow">
          <div>
            <div class="bigVal" id="windSpd">â€”</div>
            <div class="bigSub" id="windDirTxt">â€”</div>
          </div>
          <div class="windMini" aria-label="wind">
            <div class="windNeedle" id="windNeedle"></div>
            <div class="windDot"></div>
          </div>
        </div>
      </div>

      <div class="bigCard">
        <div class="bigTop">VISTA</div>
        <div class="bigVal" id="vis">â€”</div>
        <div class="bigSub">VisibilitÃ </div>
      </div>

      <div class="bigCard">
        <div class="bigTop">NUVOLE</div>
        <div class="bigVal" id="cloud">â€”</div>
        <div class="bigSub" id="cloudSub">â€”</div>
      </div>

      <div class="bigCard">
        <div class="bigTop">QNH</div>
        <div class="bigVal" id="qnh">â€”</div>
        <div class="bigSub" id="timeZ">â€”</div>
      </div>
    </div>
  </div>

  <div class="runwaysCard">
    <div class="twoCols">
      <div>
        <div class="secTitle">
          <h3>ðŸ›« Decollo</h3>
          <div class="hint">Consigliata evidenziata</div>
        </div>
        <div class="rwyGrid" id="tkofGrid"></div>
      </div>

      <div>
        <div class="secTitle">
          <h3>ðŸ›¬ Atterraggio</h3>
          <div class="hint">Consigliata evidenziata</div>
        </div>
        <div class="rwyGrid" id="ldgGrid"></div>
      </div>
    </div>
    <div class="foot" id="rwyNote">â€”</div>
  </div>

  <div class="tabs">
    <div class="tab active" id="tabMetar">RAW METAR</div>
    <div class="tab" id="tabTaf">RAW TAF</div>
  </div>
  <div class="raw" id="rawBox">â€”</div>

  <div class="foot">Meteo: MET Norway (met.no) â€¢ Airport DB: jsDelivr â€¢ Piste: OurAirports</div>
</div>

<script>
const AIRPORTS_DB = "https://cdn.jsdelivr.net/npm/airport-data@1.0.1/airports.json";
const METNO_BASE  = "https://api.met.no/weatherapi/tafmetar/1.0";
const RUNWAYS_DB  = "https://davidmegginson.github.io/ourairports-data/runways.csv";

// Traduzioni cittÃ  IT -> EN
const CITY_TRANSLATIONS = {
  "roma": "rome", "milano": "milan", "firenze": "florence", 
  "venezia": "venice", "napoli": "naples", "torino": "turin",
  "genova": "genoa", "bologna": "bologna", "palermo": "palermo",
  "bari": "bari", "catania": "catania", "verona": "verona",
  "messina": "messina", "padova": "padua", "trieste": "trieste",
  "brescia": "brescia", "pisa": "pisa", "rimini": "rimini",
  "olbia": "olbia", "cagliari": "cagliari", "alghero": "alghero",
  "brindisi": "brindisi", "ancona": "ancona", "perugia": "perugia",
  "bergamo": "bergamo", "treviso": "treviso", "cuneo": "cuneo",
  "parma": "parma", "foggia": "foggia", "reggio calabria": "reggio calabria",
  "trapani": "trapani", "comiso": "comiso", "lamezia terme": "lamezia terme",
  "pescara": "pescara", "bolzano": "bolzano", "aosta": "aosta"
};

let airports = [];
let runwaysCache = {};
let selected = null;
let rawMetarCache = "â€”";
let rawTafCache = "â€”";

const dbState = document.getElementById("dbState");
const search  = document.getElementById("search");
const sug     = document.getElementById("sug");
const btn     = document.getElementById("btn");

const hdrName = document.getElementById("hdrName");
const hdrSub  = document.getElementById("hdrSub");

const rules   = document.getElementById("rules");
const warnEl  = document.getElementById("warn");
const tempEl  = document.getElementById("temp");
const dewEl   = document.getElementById("dew");
const windSpd = document.getElementById("windSpd");
const windDirTxt = document.getElementById("windDirTxt");
const windNeedle = document.getElementById("windNeedle");
const visEl   = document.getElementById("vis");
const cloudEl = document.getElementById("cloud");
const cloudSub= document.getElementById("cloudSub");
const qnhEl   = document.getElementById("qnh");
const timeZ   = document.getElementById("timeZ");

const tkofGrid= document.getElementById("tkofGrid");
const ldgGrid = document.getElementById("ldgGrid");
const rwyNote = document.getElementById("rwyNote");

const tabMetar= document.getElementById("tabMetar");
const tabTaf  = document.getElementById("tabTaf");
const rawBox  = document.getElementById("rawBox");

function norm(x){ return (x || "").toString().trim().toLowerCase(); }
function degDiff(a,b){ let d=Math.abs(a-b); return d>180?360-d:d; }
function showSug(show){ sug.style.display = show ? "block" : "none"; }

function setTabs(which){
  tabMetar.classList.toggle("active", which==="metar");
  tabTaf.classList.toggle("active", which==="taf");
  rawBox.textContent = which==="metar" ? rawMetarCache : rawTafCache;
}
tabMetar.onclick=()=>setTabs("metar");
tabTaf.onclick=()=>setTabs("taf");

async function fetchText(url){
  const r = await fetch(url, { cache:"no-store" });
  if(!r.ok) throw new Error("HTTP "+r.status);
  return (await r.text()).trim();
}

(async function(){
  try{
    dbState.textContent = "Database: caricamentoâ€¦";
    const r = await fetch(AIRPORTS_DB, { cache:"force-cache" });
    if(!r.ok) throw new Error("HTTP "+r.status);
    airports = await r.json();
    
    const rwyText = await fetch(RUNWAYS_DB, { cache:"force-cache" }).then(r=>r.text());
    const lines = rwyText.split('\n').slice(1);
    
    for(const line of lines){
      const parts = line.split(',');
      if(parts.length < 9) continue;
      
      const icao = parts[2].replace(/"/g,'').trim().toUpperCase();
      const leIdent = parts[8].replace(/"/g,'').trim();
      const leHdg = parseFloat(parts[12]);
      const heIdent = parts[14].replace(/"/g,'').trim();
      const heHdg = parseFloat(parts[18]);
      
      if(!icao || !leIdent || isNaN(leHdg)) continue;
      
      if(!runwaysCache[icao]) runwaysCache[icao] = [];
      runwaysCache[icao].push({ident: leIdent, heading: Math.round(leHdg)});
      if(heIdent && !isNaN(heHdg)){
        runwaysCache[icao].push({ident: heIdent, heading: Math.round(heHdg)});
      }
    }
    
    dbState.textContent = `Database: pronto (${airports.length} aeroporti)`;
    btn.disabled = false;
  }catch(e){
    console.error(e);
    dbState.textContent = "Database: errore";
    btn.disabled = true;
  }
})();

search.addEventListener("input", ()=>{
  const q = norm(search.value);
  sug.innerHTML = "";
  if(!q || q.length < 2 || airports.length === 0){ showSug(false); return; }

  // Traduci cittÃ  IT -> EN se necessario
  const qTranslated = CITY_TRANSLATIONS[q] || q;

  const matches = airports.filter(a=>{
    return norm(a.icao).includes(q) || norm(a.iata).includes(q) ||
           norm(a.name).includes(q) || norm(a.city).includes(q) ||
           norm(a.city).includes(qTranslated);
  }).slice(0,20);

  if(matches.length === 0){ showSug(false); return; }

  for(const a of matches){
    const div = document.createElement("div");
    div.className="sugItem";
    const icao=(a.icao||"----").toUpperCase();
    const iata=(a.iata||"").toUpperCase();
    div.innerHTML = `<b>${icao}</b> ${a.city||"-"} â€” ${a.name||"-"}<small>${icao}${iata?(" / "+iata):""} â€¢ ${a.country||""}</small>`;
    div.onclick=()=>{
      selected=a;
      search.value = `${a.city||""} â€” ${a.name||""}`.trim();
      showSug(false);
      loadWeather();
    };
    sug.appendChild(div);
  }
  showSug(true);
});

document.addEventListener("click",(e)=>{
  if(!search.contains(e.target) && !sug.contains(e.target)) showSug(false);
});
search.addEventListener("keydown",(e)=>{ if(e.key==="Enter") btn.click(); });

btn.addEventListener("click", ()=>{
  const q = norm(search.value);
  if(!q || airports.length===0) return;

  // Traduci cittÃ  IT -> EN se necessario
  const qTranslated = CITY_TRANSLATIONS[q] || q;

  let a = airports.find(x=>norm(x.icao)===q) || airports.find(x=>norm(x.iata)===q);
  if(!a) a = airports.find(x=>norm(x.city)===q || norm(x.city)===qTranslated);
  if(!a) a = airports.find(x=>norm(x.name).includes(q));
  if(!a){ rawBox.textContent="Aeroporto non trovato. Scrivi meglio e clicca un suggerimento."; return; }

  selected=a;
  loadWeather();
});

function parseMetar(m){
  const met = (m||"").trim();
  const reports = met.split('=').filter(r => r.trim().length > 0);
  const lastLine = reports[reports.length - 1].trim();
  
  const info = { raw: lastLine, cavok: lastLine.includes("CAVOK") };

  const tg = lastLine.match(/\b(\d{2})(\d{2})(\d{2})Z\b/);
  if(tg) info.timeZ = `${tg[1]}:${tg[2]}Z`;

  const w = lastLine.match(/\b(VRB|\d{3})(\d{2,3})(G(\d{2,3}))?KT\b/);
  if(w){
    info.windDir = (w[1]==="VRB") ? null : parseInt(w[1],10);
    info.windSpd = parseInt(w[2],10);
    info.windGust= w[4] ? parseInt(w[4],10) : null;
  }

  const t = lastLine.match(/\b(M?\d{2})\/(M?\d{2})\b/);
  if(t){
    const toNum = s => s.startsWith("M") ? -parseInt(s.slice(1),10) : parseInt(s,10);
    info.tempC = toNum(t[1]);
    info.dewC  = toNum(t[2]);
  }

  const q = lastLine.match(/\bQ(\d{4})\b/);
  if(q) info.qnh = parseInt(q[1],10);

  const v = lastLine.match(/\b(9999|\d{4})\b/);
  if(v){
    info.visKm = (v[1]==="9999") ? 10 : (parseInt(v[1],10)/1000);
  }

  const c = lastLine.match(/\b(FEW|SCT|BKN|OVC)(\d{3})\b/);
  if(c){
    info.cloudCode = c[1];
    info.cloudBaseFt = parseInt(c[2],10) * 100;
  }

  return info;
}

function flightRules(info){
  if(info.cavok) return "VFR";
  if(info.visKm == null) return "â€”";
  const v = info.visKm;
  if(v >= 8) return "VFR";
  if(v >= 5) return "MVFR";
  if(v >= 1) return "IFR";
  return "LIFR";
}

function pickBestRunway(icao, windDir){
  const list = runwaysCache[icao];
  if(!list || list.length===0 || windDir==null) return null;
  let best=null, bestAngle=999;
  for(const r of list){
    const d = degDiff(r.heading, windDir);
    if(d < bestAngle){ bestAngle=d; best=r; }
  }
  return best;
}

function renderRunways(container, icao, bestIdent){
  container.innerHTML="";
  const list = runwaysCache[icao];
  if(!list || list.length===0){
    container.innerHTML = `<div class="rwyTile"><div class="r">â€”</div><div class="s">Piste non disponibili</div></div>`;
    return;
  }
  for(const r of list){
    const div = document.createElement("div");
    div.className = "rwyTile" + (bestIdent && r.ident===bestIdent ? " best" : "");
    div.innerHTML = `<div class="r">${r.ident}</div><div class="s">${r.heading}Â°</div>`;
    container.appendChild(div);
  }
}

function fmtTemp(t){ return (t==null) ? "â€”" : `${t}Â°C`; }
function fmtVis(info){
  if(info.cavok) return "10 km+";
  if(info.visKm==null) return "â€”";
  if(info.visKm>=10) return "10 km+";
  const v = Math.round(info.visKm*10)/10;
  return `${v} km`;
}
function cloudText(info){
  if(info.cavok) return { main:"Poche nubi", sub:"CAVOK" };
  if(!info.cloudCode) return { main:"â€”", sub:"Nessun dato" };
  return { main: info.cloudCode, sub: `Base ${info.cloudBaseFt} ft` };
}

function updateWindMini(info){
  if(info.windDir==null){
    windNeedle.style.transform = "rotate(0deg)";
    windDirTxt.textContent = "VRB";
    return;
  }
  windNeedle.style.transform = `rotate(${info.windDir}deg)`;
  windDirTxt.textContent = `${info.windDir}Â°`;
}

async function loadWeather(){
  if(!selected || !selected.icao) return;

  const icao = selected.icao.toUpperCase();
  btn.disabled=true; btn.textContent="Caricoâ€¦";

  try{
    hdrName.textContent = `METAR ${icao} â€¢ ${selected.name || ""}`.trim();
    hdrSub.textContent  = `${selected.city || ""}${selected.country ? " â€¢ "+selected.country : ""}`.trim();

    const met = await fetchText(`${METNO_BASE}/metar.txt?icao=${encodeURIComponent(icao)}`);
    const taf = await fetchText(`${METNO_BASE}/taf.txt?icao=${encodeURIComponent(icao)}`);

    const metarReports = met.split('=').filter(r => r.trim().length > 0);
    const lastMetar = metarReports[metarReports.length - 1].trim();
    
    rawMetarCache = lastMetar || "METAR non disponibile";
    rawTafCache   = taf || "TAF non disponibile";
    setTabs(tabTaf.classList.contains("active") ? "taf" : "metar");

    const info = parseMetar(met);

    const r = flightRules(info);
    rules.textContent = r;
    warnEl.textContent = "Nessun avvertimento";

    tempEl.textContent = fmtTemp(info.tempC);
    dewEl.textContent  = (info.dewC==null) ? "â€”" : `Dew ${info.dewC}Â°C`;

    windSpd.textContent = (info.windSpd==null) ? "â€”" : `${info.windSpd} kt${info.windGust?` G${info.windGust}`:""}`;
    updateWindMini(info);

    visEl.textContent = fmtVis(info);

    const ct = cloudText(info);
    cloudEl.textContent = ct.main;
    cloudSub.textContent = ct.sub;

    qnhEl.textContent = (info.qnh==null) ? "â€”" : `${info.qnh} hPa`;
    timeZ.textContent = info.timeZ ? info.timeZ : "â€”";

    const bestTO  = pickBestRunway(icao, info.windDir);
    const bestLDG = pickBestRunway(icao, info.windDir);

    renderRunways(tkofGrid, icao, bestTO ? bestTO.ident : null);
    renderRunways(ldgGrid, icao, bestLDG ? bestLDG.ident : null);

    const rwyList = runwaysCache[icao];
    if(!rwyList || rwyList.length===0){
      rwyNote.textContent = `Piste non disponibili nel database per ${icao}.`;
    }else{
      rwyNote.textContent = `Piste disponibili: ${rwyList.map(x=>x.ident).join(", ")} â€¢ Consigliata evidenziata.`;
    }

  }catch(e){
    console.error(e);
    rawMetarCache = "Errore METAR";
    rawTafCache = "Errore TAF";
    setTabs("metar");
  }finally{
    btn.disabled=false; btn.textContent="Carica";
  }
}
</script>
</body>
</html>